<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.app.user.mapper.MyPageMapper">
	<!-- 비밀번호 확인 -->	
	<select id="checkPassword" parameterType="String" resultType="MemberVO">
		SELECT pw
		FROM member
		WHERE mem_no = #{memNo}
	</select>
	
	<!-- 회원정보 가져오기 -->
	<select id="getMemberInfo" parameterType="String" resultType="MemberVO">
		SELECT *
		FROM member LEFT JOIN member_detail 
		USING (mem_no)
		WHERE mem_no = #{memNo}
	</select>
	
	<!-- 회원정보수정 프로시저-->
	<select id="modifyMember" parameterType="MemberVO" resultType="MemberVO">
		{
		CALL modify_member(
		#{id, mode=IN , jdbcType=VARCHAR},
		#{pw, mode=IN , jdbcType=VARCHAR},
		#{name, mode=IN , jdbcType=VARCHAR},
		#{nick, mode=IN , jdbcType=VARCHAR},
		#{mbl, mode=IN , jdbcType=VARCHAR},
		#{email, mode=IN , jdbcType=VARCHAR},
		#{zip, mode=IN , jdbcType=VARCHAR},
		#{addr, mode=IN , jdbcType=VARCHAR},
		#{detaAddr, mode=IN , jdbcType=VARCHAR},
		#{bDate, mode=IN , jdbcType=DATE},
		#{gen, mode=IN , jdbcType=VARCHAR}
		)

		}
	</select>
	
	<!-- 등업신청 -->
	<insert id="upgradeGrade" parameterType="AttachVO">
		INSERT INTO attachment (ATCH_FILE_NO,MEM_NO,ATCH_FILE_NAME,UPL_FILE_NAME,UPL_DATE,BOARD_NO)
		VALUES ('ATCH'||LPAD(ATCH_NO_SEQ.NEXTVAL,13,0),#{memNo},#{atchFileName},#{uplFileName},sysdate,'grade'||LPAD(grade_seq.NEXTVAL,12,0))
	</insert>
	
	<!-- 포인트 내역 조회 -->
	<select id="pointHistory" parameterType="String" resultType="PointsVO">
		SELECT *
		FROM points
		WHERE mem_no = #{memNo}
	</select>
	
	<!-- 회원탈퇴 -->
	<update id="secession" parameterType="String">
		UPDATE member_detail
		SET stts = 'c1'
		WHERE mem_no = #{memNo}
	</update>
	
	<!-- 결제번호 조회 -->
	<select id="myPayNo" parameterType="String" resultType="PaymentVO">
	SELECT pay_no
	FROM payment
	WHERE mem_no = #{memNo}
	</select>
	
	<!-- 결제내역 프로시저 (pay_no로 조회) -->
	<select id="myPayList" statementType="CALLABLE"
		parameterType="PaymentVO" resultType="PaymentVO">
	{
		CALL myPayList(
		#{payNo, mode=IN , jdbcType=VARCHAR},
		#{boardCtg, mode=OUT , jdbcType=VARCHAR},
		#{totalPayPrice, mode=OUT , jdbcType=VARCHAR},
		#{payMthd, mode=OUT , jdbcType=VARCHAR},
		#{payDate, mode=OUT , jdbcType=DATE},
		#{boardNo, mode=OUT , jdbcType=VARCHAR},
		#{title, mode=OUT , jdbcType=VARCHAR},
		#{rep, mode=OUT , jdbcType=VARCHAR},
		#{count, mode=OUT , jdbcType=VARCHAR}
		)

		}
	</select>
	
	<!-- 문의내역 조회 -->
	<select id="myInquiry" parameterType="String" resultType="InquiryVO">
		SELECT *
		FROM inquiry
		WHERE mem_no = #{memNo}
		ORDER BY 1 desc
	</select>
	
	<!-- 문의등록 -->
	<insert id="addInquiry" parameterType="InquiryVO">
	INSERT INTO inquiry (inq_no , mem_no , inq_title, inq_ctg , inq_desct, repl_stts, inq_date)
	VALUES (('inq'||LPAD(inquiry_seq.NEXTVAL,13,0)), #{memNo},#{inqTitle},#{inqCtg},#{inqDesct},'b0',sysdate)
	</insert>
	
	<!-- 문의상세조회 -->
	<select id="myInquiryInfo" parameterType="String" resultType="InquiryVO">
		SELECT *
		FROM inquiry
		WHERE inq_no = #{inqNo}
	</select>
	
	<!-- 알림리스트 조회 -->
	<select id="alertList" parameterType="String" resultType="AlertVO">
		SELECT *
		FROM alert
		WHERE mem_no = #{memNO}
		ORDER BY 1 desc
	</select>
	
	<!-- 상세 알림 조회 -->
	<select id="alertInfo" parameterType="String" resultType="AlertVO">
		SELECT *
		FROM alert
		WHERE alrt_no = #{alrtNo}
	</select>
	
	<!-- 알림 열람으로 변경 -->
	<update id="updateAlrtStts" parameterType="String">
		UPDATE alert
		SET alrt_stts = 'L0'
		WHERE alrt_no = #{alrt_no}	
	</update>
	
	<!-- 농지대여 나의 등록 리스트 -->
	<select id="myFarmLendList" parameterType="String" resultType="FarmLendVO">
		SELECT *
		FROM farm_lend
		WHERE mem_no = #{memNo}
		ORDER BY 1 DESC
	</select>
	
	<!-- 농지대여 나의 신청 리스트 -->
	<select id="subFarmLendList" parameterType="String" resultType="FarmLendApplyVO">
		SELECT *
		FROM farm_lend_apply
		WHERE mem_no = #{memNo}
		ORDER BY 1 DESC
	</select>
	
	<!-- 농지대여 resultMap -->
	<resultMap type="FarmLendVO" id="lendInfoResult">
		<result property="boardNo" column="board_no"/>
		<result property="zip" column="zip"/>
		<result property="addr" column="addr"/>
		<result property="detaAddr" column="deta_addr"/>
		<result property="area" column="area"/>
		<result property="desct" column="desct"/>
		<result property="lendStrDate" column="lend_str_date"/>
		<result property="lendEndDate" column="lend_end_date"/>
		<result property="lendPrice" column="lend_price"/>
		<result property="atchNo" column="atch_no"/>
		<result property="regDate" column="reg_date"/>
		<result property="regStts" column="reg_stts"/>
		<result property="lagt" column="lagt"/>
		<result property="memNo" column="mem_no"/>
		<result property="dst1" column="dst1"/>
		<result property="dst2" column="dst2"/>
		<collection property="applys" javaType="ArrayList" column="boardNo = board_no" ofType="FarmLendApplyVO" select="myFarmLendPeoList"></collection>
	</resultMap>
	
	<!-- 농지대여 상세 정보 (신청자 리스트 포함)-->
	<select id="myFarmLendInfo" resultMap="lendInfoResult">
		SELECT *
		FROM farm_lend
		WHERE board_no = #{boardNo}
		ORDER BY 1 DESC
	</select>
	
	<!-- 신청자 리스트 -->
	<select id="myFarmLendPeoList" resultType="FarmLendApplyVO">
		SELECT *
		FROM farm_lend_apply
		WHERE FRLD_LEND_NO = #{boardNo}
		ORDER BY 1 DESC
	</select>
</mapper>