<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{index}">

<head>
<meta charset="UTF-8">
<meta name="description" content="Male_Fashion Template">
<meta name="keywords" content="Male_Fashion, unica, creative, html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>농촌비앤비 상세페이지</title>
<link rel="stylesheet"
	href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="/css/suinCss/review.css">
<style>
#dateTb td {
	text-align: right;
	padding-right: 80px;
}
</style>
</head>

<body>
	<div layout:fragment="content">
		<!-- Shop Details Section Begin -->
		<section th:each="bnb:${bnb}" class="shop-details">
			<!-- 이미지 부분 -->
			<div class="product__details__pic">
				<div class="container">
					<div class="row">
						<div class="col-lg-12" style="text-align: left">
							<div class="product__details__breadcrumb">
								<a href="/bnbList">농촌비엔비</a> <span th:text="|${bnb.title}|">제목넣기</span>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-lg-3 col-md-3"></div>
						<div class="col-lg-6 col-md-9">
							<div class="tab-content">
								<div class="tab-pane active" id="tabs-1" role="tabpanel">
									<div class="product__details__pic__item">
										<img th:src="${bnb.rep}" alt="대표사진">
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="product__details__content">
				<div class="container">
					<!-- 제품제목,결제버튼 -->
					<div class="row d-flex justify-content-center">
						<div class="col-lg-8">
							<div class="product__details__text">
								<h3 th:text="|${bnb.title}|">제목</h3>
								<div class="rating">
									<i class="fa fa-star"></i> <i class="fa fa-star"></i> <i
										class="fa fa-star"></i> <i class="fa fa-star"></i> <i
										class="fa fa-star-o"></i> <span> - 5 Reviews</span>
								</div>
								<h4>
									<span id="onePay" th:text="|${bnb.price}|"
										style="display: none"></span> <span
										th:text="${#numbers.formatInteger(bnb.price==null?0:bnb.price,0,'COMMA')}">금액</span>원(1일)
								</h4>
								<p>농촌 한달살기 체험 해보세요!</p>

								<!-- 결제 -->
								<div>

									<table class="table" id="dateTb">
										<tr>
											<th>날짜 선택</th>
											<td><input type="date" id="startDate"
												th:min="${#dates.format(bnb.lendStrDate,'yyyy-MM-dd')}"
												th:max="${#dates.format(bnb.lendEndDate,'yyyy-MM-dd')}"
												onchange="minDate()"> ~ <input type="date"
												id="endDate"
												th:min="${#dates.format(bnb.lendStrDate,'yyyy-MM-dd')}"
												th:max="${#dates.format(bnb.lendEndDate,'yyyy-MM-dd')}"
												onchange="calculateDays()"></td>
										</tr>
										<tr>
											<th>총 일수</th>
											<td><span id="dateResult"></span> 일</td>
										</tr>
										<tr>

											<th>총 금액</th>
											<td><b><span id="payResult"></span></b> 원</td>
										</tr>
										<tr>
											<th colspan="2">
												<div class="product__details__cart__option">
													<a href="#" class="primary-btn">예약 및 결제하기</a>
												</div>
											</th>
										</tr>
									</table>

								</div>

							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-lg-12">
							<div class="product__details__tab">
								<!-- 상세설명, 리뷰, 문의사항 탭 -->
								<ul class="nav nav-tabs" role="tablist">
									<li class="nav-item"><a class="nav-link active"
										data-toggle="tab" href="#tabs-5" role="tab">상세설명</a></li>
									<li class="nav-item"><a class="nav-link" data-toggle="tab"
										href="#tabs-6" role="tab">리뷰</a></li>
									<li class="nav-item"><a class="nav-link" data-toggle="tab"
										href="#tabs-7" role="tab">문의처</a></li>
								</ul>
								<div class="tab-content">
									<!-- 첫번째 탭 : 상세설명 ck editor -->
									<div class="tab-pane active" id="tabs-5" role="tabpanel">
										<div class="product__details__tab__content">
											<p class="note">숙소 안내</p>
											<div class="product__details__tab__content__item"
												th:utext="|${bnb.detaDesct}|">ck editor에서 넣은 내용</div>
											<!-- 지도 api -->
											<div class="product__details__tab__content__item">
												<p class="note">위치</p>
												<div id="map" style="width: 750px; height: 300px;"></div>
											</div>
										</div>
									</div>
									<!-- 두번째 탭: 리뷰 -->
									<div class="tab-pane" id="tabs-6" role="tabpanel">
										<div class="product__details__tab__content">
											<div class="product__details__tab__content__item">
												<div id="reviewArea">
													<!-- 리뷰 등록 폼 -->
													<div class="review-form">
														<div class="row1">
															<label for="star">별점:</label> <select id="star">
																<option value="0">별점</option>
																<option value="5">★★★★★</option>
																<option value="4">★★★★☆</option>
																<option value="3">★★★☆☆</option>
																<option value="2">★★☆☆☆</option>
																<option value="1">★☆☆☆☆</option>
															</select>
														</div>

														<div class="row1">
															<label for="reviewText">리뷰:</label>
															<textarea id="reviewText" rows="2" cols="30"></textarea>
															<input id="addBtn" type="submit" value="등록">
														</div>
													</div>

													<table id="reviewTable" class="table"
														style="text-align: center">
														<thead>
															<tr>
																<th>번호</th>
																<th>별점</th>
																<th>내용</th>
																<th>작성자</th>
																<th>삭제</th>
															</tr>
														</thead>
														<tbody>
														</tbody>
													</table>
												</div>
											</div>
										</div>
									</div>
									<!-- 세번째 탭 -->
									<div class="tab-pane" id="tabs-7" role="tabpanel">
										<div class="product__details__tab__content">
											<p class="note">문의는 아래 사항으로 연락 바랍니다.</p>
											<div class="product__details__tab__content__item">
												<h5>판매자 정보</h5>
												<p>판매자: 000</p>
												<p>전화번호: 054-4545-8584</p>
												<p>주 소: 경상북도 청도 어쩌구</p>
											</div>
											<div class="product__details__tab__content__item">
												<h5>Material used</h5>
												<p>Po.</p>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<br> <br> <br> <br>
				</div>
			</div>
		</section>
		<!-- Shop Details Section End -->
		<!-- 지도 api -->
		<script
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c573b65eabeb9b6da24ab52d832dc807"></script>
		<script th:inline="javascript">
			///////지도 api
			var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
			mapOption = {
				center : new kakao.maps.LatLng(37.56682, 126.97865), // 지도의 중심좌표
				level : 3, // 지도의 확대 레벨
				mapTypeId : kakao.maps.MapTypeId.ROADMAP
			};
			var map = new kakao.maps.Map(mapContainer, mapOption);
			// 지도에 마커를 생성하고 표시한다
			var marker = new kakao.maps.Marker({
				position : new kakao.maps.LatLng(37.56682, 126.97865), // 마커의 좌표
				map : map
			});
			//////// 결제시 날짜 기능
			function calculateDays() {
				var startDate = new Date(
						document.getElementById('startDate').value);
				var endDate = new Date(document.getElementById('endDate').value);
				var timeDifference = endDate.getTime() - startDate.getTime();
				var days = timeDifference / (1000 * 3600 * 24) + 1;
				var nights = timeDifference / (1000 * 3600 * 24);
				// 날짜계산
				console.log('일 수:', days);
				var resultElement = document.getElementById('dateResult');
				resultElement.textContent = nights + " 박 " + days;
				// 금액계산
				var pay = document.getElementById('payResult');
				var onePay = document.getElementById('onePay').innerText;
				let total = days * onePay;
				total = number_format(total);
				pay.textContent = total;
			}
			//최소날짜 설정
			function minDate() {
				let min = event.target.value;
				console.log(min);
				document.getElementById('endDate').setAttribute('min', min);
			}

			///// 금액-천단위 콤마찍기 함수
			function number_format(num) {
				return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
			}

			///// 리뷰 기능		
		  	/*<![CDATA[*/
			let boardNo= /*[[${bnb.boardNo}]]*/;
			 /*]]>*/
			 
			//리뷰-조회
			$(document).ready(function() {		
				reviewAjax();
				
			});

			 function reviewAjax(){			
			 $('#reviewTable>tbody').children().remove();
			 $.ajax({
					url : `bnbInfo/review`, 
					method : 'GET',
					data : {boardNo}, 
					dataType : 'json',
					success : function(list) {
						console.log(list); 
						printReview(list);						
					},
					error : function(error) {
						console.error(error); 
					}
				});
			 }

			function printReview(list){
				list.forEach(el => {
			      let rate = el.rate;
 			      let review = el.revDesct;
 			      let nick = el.nick; 	
			      let del = $('<button>삭제</button>');
			      let newRow = ($('<tr>').append($('<td>').text('1'))
								        .append($('<td>').text(makeStars(rate)))
								        .append($('<td>').text(review))
								        .append($('<td>').text(nick))
								        .append($('<td>').append(del))    
			       				 )             
			      $('#reviewTable>tbody').append(newRow)							
				})
			}
			
			//별찍기 함수
			
		      function makeStars(num) {
		       let stars = '';
		       for (let i=0; i<num; i++) {
		            stars += '★';
		          }
		       for(let j=num; j<5;j++){
		          	stars += '☆';
		          }
		       return stars;
		       }

			
			//리뷰등록기능
			
		  	/*<![CDATA[*/
			let mem= /*[[${session.mem}]]*/;
			 /*]]>*/	

			 $('#addBtn').on('click',function(){
				let star = $('#star').val();
				let text = $('#reviewText').val(); 
				let day= new Date();
			 	let today = day.getFullYear()+'/'+day.getMonth()+'/'+day.getDate();
				//
				$.ajax({
					url : `bnbInfo/review`, 
					method : 'POST',
					data : {memNo:mem.memNo, 
							rate:star,
							revDesct:text,
							boardNo: boardNo,
							wrtDate:today}, 
					dataType : 'json',
					success : function(result) {
						console.log(result); 
						reviewAjax();
					},
					error : function(error) {
						console.error(error); 
					}
				});
			})
			 
		</script>
	</div>
</body>

</html>